<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Ventas - Fruitsha Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="styles.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <script src="firebase.js"></script>
  <!-- LibrerÃ­a para exportar a Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <header>
    <h1>Registro de Ventas</h1>
  </header>

  <main>
    <h2>Registrar venta</h2>
    <input type="text" id="producto" placeholder="Producto vendido">
    <input type="number" id="cantidad" placeholder="Cantidad">
    <input type="number" id="precio" placeholder="Precio unitario">
    <button id="registrar">Registrar venta</button>

    <h2>Historial de ventas</h2>
    <div id="ventas"></div>
    <button id="exportar">Exportar a Excel</button>
  </main>

  <script>
    const db = firebase.firestore();
    const ventasDiv = document.getElementById('ventas');
    const registrarBtn = document.getElementById('registrar');
    const exportarBtn = document.getElementById('exportar');

    // Cargar ventas en tiempo real
    db.collection("ventas").orderBy("fecha", "desc").onSnapshot(snapshot => {
      ventasDiv.innerHTML = '';
      snapshot.forEach(doc => {
        const venta = doc.data();
        const div = document.createElement('div');
        div.innerHTML = `
          <h3>${venta.producto}</h3>
          <p>Cantidad: ${venta.cantidad}</p>
          <p>Precio unitario: S/ ${venta.precio}</p>
          <p>Total: S/ ${(venta.cantidad * venta.precio).toFixed(2)}</p>
          <p>Fecha: ${new Date(venta.fecha.seconds * 1000).toLocaleString()}</p>
        `;
        ventasDiv.appendChild(div);
      });
    });

    // Registrar nueva venta
    registrarBtn.addEventListener('click', async () => {
      const producto = document.getElementById('producto').value;
      const cantidad = parseInt(document.getElementById('cantidad').value);
      const precio = parseFloat(document.getElementById('precio').value);

      if (!producto || isNaN(cantidad) || isNaN(precio)) {
        alert('Por favor, completa todos los campos.');
        return;
      }

      await db.collection("ventas").add({
        producto,
        cantidad,
        precio,
        fecha: new Date()
      });

      alert('Venta registrada correctamente');
    });

    // Exportar ventas a Excel
    exportarBtn.addEventListener('click', async () => {
      const snapshot = await db.collection("ventas").orderBy("fecha", "desc").get();
      const datos = [];
      snapshot.forEach(doc => {
        const venta = doc.data();
        datos.push({
          Producto: venta.producto,
          Cantidad: venta.cantidad,
          "Precio Unitario": venta.precio,
          Total: venta.cantidad * venta.precio,
          Fecha: new Date(venta.fecha.seconds * 1000).toLocaleString()
        });
      });

      const hoja = XLSX.utils.json_to_sheet(datos);
      const libro = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(libro, hoja, "Ventas");
      XLSX.writeFile(libro, "ventas.xlsx");
    });
  </script>
</body>
</html>
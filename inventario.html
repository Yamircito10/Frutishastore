<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventario - Frutisha Store</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .inventario-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }
    .producto-item {
      background: #fff;
      border: 1px solid var(--rosa);
      border-radius: 12px;
      padding: 12px;
      text-align: left;
      box-shadow: 0 2px 5px rgba(0,0,0,0.08);
    }
    .producto-item h3{
      margin: 0 0 8px 0;
      color: var(--principal);
      font-size: 18px;
      text-align: center;
    }
    .producto-item label{
      font-weight: 600;
      display: block;
      margin-top: 6px;
    }
    .producto-item input {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      text-align: center;
    }

    /* Editor de tallas */
    .tallas-box {
      margin-top: 10px;
      background: #fff8fb;
      border: 1px dashed var(--rosa);
      border-radius: 10px;
      padding: 10px;
    }
    .tallas-header{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }
    .tallas-header strong{ color: var(--principal); }
    .fila-talla{
      display: grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap: 8px;
      align-items: center;
      margin-bottom: 6px;
    }
    .btn{
      background: var(--rosa);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 10px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn:hover{ background: var(--rosa-oscuro); }
    .btn-sec{
      background: #f1f3f5;
      color: #333;
    }
    .btn-sec:hover{ background:#e9ecef; }
    .btn-danger{
      background:#dc3545;
    }
    .btn-danger:hover{
      background:#b02a37;
    }

    .acciones-globales{
      margin-top: 14px;
      text-align: center;
    }

    /* Nueva prenda */
    .nuevo-item {
      background: #f8f9fa;
      border: 2px dashed var(--rosa);
      border-radius: 12px;
      padding: 12px;
      margin-top: 18px;
      text-align: left;
    }
    .nuevo-item h3{
      text-align:center;
      margin-top:0;
      color: var(--principal);
    }
    .volver{
      margin-top: 8px;
      text-align:center;
    }

    @media (max-width:600px){
      .fila-talla{
        grid-template-columns: 1fr 1fr 1fr 44px;
      }
    }
  </style>
</head>
<body>

<script>
  // üîí Solo ADMIN
  const usuario = localStorage.getItem("usuarioActivo");
  const rol = localStorage.getItem("rolActivo");
  if (!usuario || rol !== "admin") {
    alert("‚ùå Acceso denegado. Solo administradores pueden ver el inventario.");
    window.location.href = "index.html";
  }
</script>

<h1>üì¶ Inventario - Frutisha Store</h1>

<div class="acciones volver">
  <button class="btn btn-sec" onclick="location.href='index.html'">üè™ Volver a la Tienda</button>
</div>

<div class="acciones-globales">
  <button class="btn" onclick="guardarTodos()">üíæ Guardar TODOS</button>
</div>

<div class="inventario-container" id="contenedor-inventario"></div>

<!-- ‚ûï Nueva prenda -->
<div class="nuevo-item">
  <h3>‚ûï Agregar nueva prenda</h3>
  <label>Nombre</label>
  <input type="text" id="nuevo-nombre" placeholder="Nombre de la prenda">

  <label>Precio base (opcional, se usa si alguna talla no tiene precio)</label>
  <input type="number" id="nuevo-precio" placeholder="Ej. 35" min="0" step="0.01">

  <label>Stock general (se calcular√° autom√°ticamente, puedes dejarlo vac√≠o)</label>
  <input type="number" id="nuevo-stock" placeholder="(auto)" min="0" step="1" disabled>

  <div class="tallas-box">
    <div class="tallas-header">
      <strong>Tallas (talla + precio + stockTalla)</strong>
      <button class="btn btn-sec" onclick="addTallaNueva()">‚ûï A√±adir talla</button>
    </div>
    <div id="nuevo-tallas"></div>
  </div>

  <div class="acciones-globales">
    <button class="btn" onclick="agregarPrenda()">‚úÖ Guardar prenda</button>
  </div>
</div>

<div class="acciones volver">
  <button class="btn btn-sec" onclick="location.href='index.html'">üè™ Volver a la Tienda</button>
</div>

<!-- ‚úÖ Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "TU_API_KEY",
    authDomain: "frutisha-store.firebaseapp.com",
    projectId: "inventario-ab270",
    storageBucket: "frutisha-store.appspot.com",
    messagingSenderId: "15388676345",
    appId: "1:15388676345:web:72c8e22a2aece1d4151228"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
</script>

<script>
  let prendasInv = [];

  // üì• Cargar inventario
  async function cargarInventario() {
    const snap = await db.collection("inventario").get();
    prendasInv = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderInventario();
  }

  // üñºÔ∏è Render de tarjetas
  function renderInventario() {
    const cont = document.getElementById("contenedor-inventario");
    cont.innerHTML = "";

    if (!prendasInv.length) {
      cont.innerHTML = "<p style='grid-column:1/-1; text-align:center;'>‚ö†Ô∏è No hay productos en el inventario.</p>";
      return;
    }

    prendasInv.forEach((item, i) => {
      const tallas = Array.isArray(item.tallas) ? item.tallas : [];
      const stockGeneral = tallas.reduce((ac, t) => ac + (Number(t.stockTalla) || 0), 0);

      const div = document.createElement("div");
      div.className = "producto-item";
      div.innerHTML = `
        <h3>${item.nombre || "Sin nombre"}</h3>

        <label>Nombre</label>
        <input type="text" id="nombre-${i}" value="${item.nombre || ""}">

        <label>Precio base (opcional)</label>
        <input type="number" id="precio-${i}" value="${item.precio ?? ""}" min="0" step="0.01">

        <label>Stock general (auto)</label>
        <input type="number" id="stock-${i}" value="${stockGeneral}" min="0" step="1" disabled>

        <div class="tallas-box">
          <div class="tallas-header">
            <strong>Tallas</strong>
            <button class="btn btn-sec" onclick="addTalla(${i})">‚ûï A√±adir talla</button>
          </div>
          <div id="tallas-${i}"></div>
        </div>

        <div class="acciones-globales">
          <button class="btn" onclick="guardarUno(${i})">üíæ Guardar</button>
          <button class="btn btn-danger" onclick="eliminarPrenda('${item.id}')">üóë Eliminar</button>
        </div>
      `;
      cont.appendChild(div);

      // Pintar filas de tallas existentes
      const lista = document.getElementById(`tallas-${i}`);
      tallas
        .sort((a,b) => (Number(a.talla)||0) - (Number(b.talla)||0))
        .forEach((t, idx) => {
          lista.appendChild(crearFilaTalla(i, idx, t.talla, t.precio, t.stockTalla));
        });
      if (!tallas.length) addTalla(i);
    });
  }

  // üß± Crea nodo de fila de talla
  function crearFilaTalla(i, idx, tallaVal = "", precioVal = "", stockVal = "") {
    const fila = document.createElement("div");
    fila.className = "fila-talla";
    fila.dataset.index = idx;
    fila.innerHTML = `
      <input type="number" placeholder="Talla (ej. 4)" min="0" step="1" value="${tallaVal}" id="talla-${i}-${idx}">
      <input type="number" placeholder="Precio (ej. 35)" min="0" step="0.01" value="${precioVal}" id="precioT-${i}-${idx}">
      <input type="number" placeholder="Stock talla (ej. 5)" min="0" step="1" value="${stockVal}" id="stockT-${i}-${idx}">
      <button class="btn btn-danger" title="Quitar" onclick="quitarTalla(${i}, ${idx})">‚úñ</button>
    `;
    return fila;
  }

  // ‚ûï A√±adir fila talla (existente)
  function addTalla(i) {
    const box = document.getElementById(`tallas-${i}`);
    const idx = box.querySelectorAll(".fila-talla").length;
    box.appendChild(crearFilaTalla(i, idx));
  }

  // ‚úñ Quitar fila talla (existente)
  function quitarTalla(i, idx) {
    const box = document.getElementById(`tallas-${i}`);
    const fila = box.querySelector(`.fila-talla:nth-child(${idx + 1})`);
    if (fila) box.removeChild(fila);
    // Re-indexar ids
    [...box.querySelectorAll(".fila-talla")].forEach((f, newIdx) => {
      f.dataset.index = newIdx;
      f.querySelectorAll("input")[0].id = `talla-${i}-${newIdx}`;
      f.querySelectorAll("input")[1].id = `precioT-${i}-${newIdx}`;
      f.querySelectorAll("input")[2].id = `stockT-${i}-${newIdx}`;
      f.querySelector("button").setAttribute("onclick", `quitarTalla(${i}, ${newIdx})`);
    });
    // actualizar vista de stock general (solo visual)
    recalculaStockVisual(i);
  }

  function recalculaStockVisual(i){
    const box = document.getElementById(`tallas-${i}`);
    const filas = box.querySelectorAll(".fila-talla");
    let suma = 0;
    filas.forEach(f => {
      const st = Number(f.querySelector(`#stockT-${i}-${f.dataset.index}`).value) || 0;
      suma += st;
    });
    const inputStock = document.getElementById(`stock-${i}`);
    if (inputStock) inputStock.value = suma;
  }

  // üíæ Guardar UNA prenda
  async function guardarUno(i) {
    const docId = prendasInv[i].id;
    const nombre = document.getElementById(`nombre-${i}`).value.trim();
    const precioBase = document.getElementById(`precio-${i}`).value;

    const tallasBox = document.getElementById(`tallas-${i}`);
    const filas = tallasBox.querySelectorAll(".fila-talla");
    const tallas = [];
    filas.forEach((f) => {
      const idx = Number(f.dataset.index);
      const tallaNum = Number(document.getElementById(`talla-${i}-${idx}`).value);
      const precioNum = Number(document.getElementById(`precioT-${i}-${idx}`).value);
      const stockNum = Number(document.getElementById(`stockT-${i}-${idx}`).value);
      if (!isNaN(tallaNum) && document.getElementById(`talla-${i}-${idx}`).value !== "" &&
          !isNaN(precioNum) && document.getElementById(`precioT-${i}-${idx}`).value !== "" &&
          !isNaN(stockNum) && document.getElementById(`stockT-${i}-${idx}`).value !== "") {
        tallas.push({ talla: tallaNum, precio: precioNum, stockTalla: stockNum });
      }
    });

    const stockGeneral = tallas.reduce((ac, t) => ac + (Number(t.stockTalla) || 0), 0);

    const updateData = {
      nombre: nombre || "",
      tallas,
      stock: stockGeneral, // para compatibilidad y referencia r√°pida
    };
    if (precioBase !== "") updateData.precio = Number(precioBase);

    await db.collection("inventario").doc(docId).update(updateData);
    alert("‚úÖ Prenda actualizada");
    await cargarInventario();
  }

  // üíæ Guardar TODOS
  async function guardarTodos() {
    for (let i = 0; i < prendasInv.length; i++) {
      await guardarUno(i);
    }
  }

  // üóë Eliminar prenda
  async function eliminarPrenda(id) {
    if (!confirm("¬øSeguro que deseas eliminar esta prenda?")) return;
    await db.collection("inventario").doc(id).delete();
    alert("üóë Prenda eliminada");
    await cargarInventario();
  }

  // ‚ûï Nueva prenda ‚Äì tallas
  function addTallaNueva() {
    const cont = document.getElementById("nuevo-tallas");
    const idx = cont.querySelectorAll(".fila-talla").length;
    const fila = document.createElement("div");
    fila.className = "fila-talla";
    fila.innerHTML = `
      <input type="number" id="nuevo-talla-${idx}" placeholder="Talla (ej. 4)" min="0" step="1">
      <input type="number" id="nuevo-precio-${idx}" placeholder="Precio (ej. 35)" min="0" step="0.01">
      <input type="number" id="nuevo-stock-${idx}"  placeholder="Stock talla (ej. 5)" min="0" step="1">
      <button class="btn btn-danger" onclick="this.parentElement.remove()">‚úñ</button>
    `;
    cont.appendChild(fila);
  }

  // ‚úÖ Agregar prenda nueva
  async function agregarPrenda() {
    const nombre = document.getElementById("nuevo-nombre").value.trim();
    const precio = document.getElementById("nuevo-precio").value;

    if (!nombre) {
      alert("‚ö†Ô∏è Ingresa el nombre de la prenda");
      return;
    }

    // recolectar tallas nuevas
    const cont = document.getElementById("nuevo-tallas");
    const filas = cont.querySelectorAll(".fila-talla");
    const tallas = [];
    filas.forEach((f, idx) => {
      const tallaVal = Number(document.getElementById(`nuevo-talla-${idx}`).value);
      const precioVal = Number(document.getElementById(`nuevo-precio-${idx}`).value);
      const stockVal = Number(document.getElementById(`nuevo-stock-${idx}`).value);
      if (!isNaN(tallaVal) && document.getElementById(`nuevo-talla-${idx}`).value !== "" &&
          !isNaN(precioVal) && document.getElementById(`nuevo-precio-${idx}`).value !== "" &&
          !isNaN(stockVal) && document.getElementById(`nuevo-stock-${idx}`).value !== "") {
        tallas.push({ talla: tallaVal, precio: precioVal, stockTalla: stockVal });
      }
    });

    const stockGeneral = tallas.reduce((ac, t) => ac + (Number(t.stockTalla) || 0), 0);

    const newDoc = {
      nombre,
      tallas,
      stock: stockGeneral, // para referencia r√°pida
    };
    if (precio !== "") newDoc.precio = Number(precio);

    await db.collection("inventario").add(newDoc);

    // limpiar
    document.getElementById("nuevo-nombre").value = "";
    document.getElementById("nuevo-precio").value = "";
    document.getElementById("nuevo-tallas").innerHTML = "";

    alert("‚úÖ Nueva prenda agregada");
    await cargarInventario();
  }

  // üöÄ Init
  cargarInventario();
</script>

</body>
</html>
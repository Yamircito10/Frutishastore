<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Historial de Ventas - Frutisha Store</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

<script>
  // âœ… Verificar login antes de mostrar el historial
  const usuario = localStorage.getItem("usuarioActivo");
  if (!usuario) {
    window.location.href = "login.html";
  }
</script>

<h1>ğŸ“š Historial de Ventas</h1>

<div class="acciones" style="text-align:center; margin-bottom:10px;">
  <input type="date" id="fechaInicio" />
  <input type="date" id="fechaFin" />
  <button onclick="cargarHistorial()">ğŸ” Filtrar por Fechas</button>
  <button onclick="descargarHistorial()">ğŸ“¥ Descargar Historial</button>
  <button onclick="borrarHistorial()">ğŸ—‘ Borrar Todo</button>
  <button onclick="location.href='index.html'">ğŸª Volver a Tienda</button>
</div>

<ul id="listaHistorial"></ul>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBtNWOs53cdTm0SYUZe_qCQb4OC-_VdcMQ",
    authDomain: "frutisha-store.firebaseapp.com",
    projectId: "inventario-ab270",
    storageBucket: "frutisha-store.appspot.com",
    messagingSenderId: "15388676345",
    appId: "1:15388676345:web:72c8e22a2aece1d4151228"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
</script>

<!-- Helper -->
<script src="ventas-helper.js"></script>

<script>
let historial = [];

function parseFechaEs(fechaStr) {
  if (!fechaStr) return null;
  const [d,m,y] = fechaStr.split('/').map(x => parseInt(x,10));
  return new Date(y, m-1, d);
}

async function cargarHistorial() {
  const inicio = document.getElementById("fechaInicio").value;
  const fin = document.getElementById("fechaFin").value;
  const lista = document.getElementById("listaHistorial");
  lista.innerHTML = "<li>Cargando...</li>";

  try {
    const snap = await db.collection("ventas").orderBy("fecha","desc").get();
    historial = snap.docs.map(d => d.data());

    let historialFiltrado = historial;
    if (inicio && fin) {
      const dInicio = new Date(inicio);
      const dFin = new Date(fin);
      dFin.setHours(23,59,59,999);
      historialFiltrado = historial.filter(v => {
        const vFecha = parseFechaEs(v.fecha);
        return vFecha && vFecha >= dInicio && vFecha <= dFin;
      });
    }

    if (historialFiltrado.length === 0) {
      lista.innerHTML = "<li>No hay ventas registradas en ese rango.</li>";
      return;
    }

    lista.innerHTML = historialFiltrado.map((venta,i) => `
      <li>
        <strong>Venta ${i+1}</strong> â€” ğŸ“… ${venta.fecha} ğŸ•’ ${venta.hora}<br>
        ${venta.productos.map(p => `ğŸ”¹ ${p}`).join("<br>")}
        <br>ğŸ’µ Total: <strong>${formatearSoles(venta.total)}</strong>
      </li>
    `).join("");

  } catch(e) {
    console.error(e);
    lista.innerHTML = "<li>âŒ Error al cargar el historial.</li>";
  }
}

function descargarHistorial() {
  if (!historial || historial.length === 0) {
    alert("âš ï¸ No hay historial para exportar.");
    return;
  }

  const inicio = document.getElementById("fechaInicio").value || "inicio";
  const fin = document.getElementById("fechaFin").value || "fin";

  let historialFiltrado = historial;
  if (inicio !== "inicio" && fin !== "fin") {
    const dInicio = new Date(inicio);
    const dFin = new Date(fin);
    dFin.setHours(23,59,59,999);
    historialFiltrado = historial.filter(v => {
      const vFecha = parseFechaEs(v.fecha);
      return vFecha && vFecha >= dInicio && vFecha <= dFin;
    });
  }

  descargarTxt(historialFiltrado, `${inicio}_a_${fin}`);
}

async function borrarHistorial() {
  if (!confirm("Â¿Seguro que quieres borrar todo el historial?")) return;
  try {
    const snap = await db.collection("ventas").get();
    const batch = db.batch();
    snap.forEach(doc => batch.delete(doc.ref));
    await batch.commit();
    alert("ğŸ—‘ Historial borrado correctamente.");
    cargarHistorial();
  } catch(e) {
    console.error(e);
    alert("âŒ Error al borrar historial.");
  }
}

// Cargar historial al abrir
cargarHistorial();
</script>

</body>
</html>